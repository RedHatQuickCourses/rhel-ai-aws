<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Develop RHEL AI AMI on RHEL 9 AWS Instance :: Deploying Red Hat Enterprise Linux AI on AWS</title>
    <link rel="prev" href="section1.html">
    <link rel="next" href="section3.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Deploying Red Hat Enterprise Linux AI on AWS</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/rhel-ai-aws/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rhel-ai-aws" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Deploying Red Hat Enterprise Linux AI on AWS</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Deploying RHEL AI on AWS</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../LABENV/index.html">Lab Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Lab: Configuring VPC for the Lab Environment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="section1.html">Lab: Launch RHEL 9 AWS Instance</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="section2.html">Lab: Develop RHEL AI AMI on RHEL 9 AWS Instance</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="section3.html">Lab: Deploying RHEL AI instance on AWS using the CLI</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Deploying Red Hat Enterprise Linux AI on AWS</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Deploying Red Hat Enterprise Linux AI on AWS</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Deploying Red Hat Enterprise Linux AI on AWS</a></li>
    <li><a href="section2.html">Lab: Develop RHEL AI AMI on RHEL 9 AWS Instance</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Develop RHEL AI AMI on RHEL 9 AWS Instance</h1>
<div class="paragraph">
<p>In this lab exercise, you&#8217;ll build a customized RHEL AI AMI on the launched RHEL 9 AWS instance to streamline future deployments of RHEL AI cloud instance.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Install <em>aws cli</em> on newly launched RHEL 9 AWS instance.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Switch to <em>root</em> user and download <em>awscli-exe</em> file using the following command:</p>
<div class="listingblock">
<div class="content">
<pre>[ec2-user@ip-172-17-1-180 ~]$ sudo su -
[root@ip-172-17-1-180 ~]# curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"</pre>
</div>
</div>
</li>
<li>
<p>Install <em>zip</em> package to <em>unzip</em> the downloaded package.</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# yum install zip -y</pre>
</div>
</div>
</li>
<li>
<p>Unzip the downloaded package.</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# unzip awscliv2.zip</pre>
</div>
</div>
</li>
<li>
<p>Install <em>aws cli</em> using using the following command and confirm the installed <em>aws cli</em> version:</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# sudo ./aws/install
You can now run: /usr/local/bin/aws --version

[root@ip-172-17-1-180 ~]# aws --version
aws-cli/2.17.56 Python/3.12.6 Linux/5.14.0-427.20.1.el9_4.x86_64 exe/x86_64.rhel.9</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Configure the <em>aws cli</em></p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Set up your <em>AWS Access Key ID</em>, <em>Secret Access Key</em>, and define the instance region to ensure seamless interaction with your AWS environment.</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# aws configure
AWS Access Key ID [None]: <em>your access key id</em>
AWS Secret Access Key [None]: <em>your secret access key</em>
Default region name [None]: <em>your vpc configured region name</em>
Default output format [None]:</pre>
</div>
</div>
</li>
<li>
<p>Confirm the configured settings using the following command:</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# aws configure list</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Converting the RHEL AI image to an AWS AMI</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the necessary environment variables by running the following commands. Replace the &lt;custom_bucket_name&gt; with a new name that has to be unique. Also on AWS, the DEFAULT_VOLUME_SIZE is measured GBs.</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# export BUCKET=&lt;custom_bucket_name&gt;
[root@ip-172-17-1-180 ~]# export RAW_AMI=nvidia-bootc.ami
[root@ip-172-17-1-180 ~]# export AMI_NAME="rhel-ai"
[root@ip-172-17-1-180 ~]# export DEFAULT_VOLUME_SIZE=1000</pre>
</div>
</div>
</li>
<li>
<p>You can create an S3 bucket by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# aws s3 mb s3://$BUCKET
make_bucket: &lt;custom_bucket_name&gt;</pre>
</div>
</div>
</li>
<li>
<p>You must create a trust-policy.json file with the necessary configurations for generating a S3 role for your bucket:</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# printf '{ "Version": "2012-10-17", "Statement": [ { "Effect": "Allow", "Principal": { "Service": "vmie.amazonaws.com" }, "Action": "sts:AssumeRole", "Condition": { "StringEquals":{ "sts:Externalid": "vmimport" } } } ] }' &gt; trust-policy.json</pre>
</div>
</div>
</li>
<li>
<p>Create an S3 role for your bucket that you can name. In the following example command, <em>vmiport</em> is the name of the role.</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# aws iam create-role --role-name vmimport --assume-role-policy-document <a href="file://trust-policy.json" class="bare">file://trust-policy.json</a></pre>
</div>
</div>
</li>
<li>
<p>You must create a role-policy.json file with the necessary configurations for generating a policy for your bucket:</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# $ printf '{ "Version":"2012-10-17", "Statement":[ { "Effect":"Allow", "Action":[ "s3:GetBucketLocation", "s3:GetObject", "s3:ListBucket" ], "Resource":[ "arn:aws:s3:::%s", "arn:aws:s3:::%s/<strong>" ] }, { "Effect":"Allow", "Action":[ "ec2:ModifySnapshotAttribute", "ec2:CopySnapshot", "ec2:RegisterImage", "ec2:Describe</strong>" ], "Resource":"*" } ] }' $BUCKET $BUCKET &gt; role-policy.json</pre>
</div>
</div>
</li>
<li>
<p>Create a policy for your bucket by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# aws iam put-role-policy --role-name vmimport --policy-name vmimport-$BUCKET --policy-document <a href="file://role-policy.json" class="bare">file://role-policy.json</a></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Now that your S3 bucket is set up, you need to download the RAW image from <a href="https://access.redhat.com/downloads/content/932/ver=1.1/rhel---9/1.1/x86_64/product-software">Red Hat Enterprise Linux AI download page</a>.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Copy the <strong>rhel-ai-nvidia-1.1-1725056698-x86_64.raw</strong> RAW image link and add it to the following command. This steps can take around 3 to 4 hours approximately.</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# curl -Lo disk.raw &lt;link-to-raw-file&gt;</pre>
</div>
</div>
</li>
<li>
<p>Upload the image to the S3 bucket with the following command. This steps can take around 1 to 2 hours approximately.</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# aws s3 cp disk.raw s3://$BUCKET/$RAW_AMI</pre>
</div>
</div>
</li>
<li>
<p>Convert the image to a snapshot and store it in the task_id variable name by running the following commands:</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# printf '{ "Description": "my-image", "Format": "raw", "UserBucket": { "S3Bucket": "%s", "S3Key": "%s" } }' $BUCKET $RAW_AMI &gt; containers.json
[root@ip-172-17-1-180 ~]# task_id=$(aws ec2 import-snapshot --disk-container <a href="file://containers.json" class="bare">file://containers.json</a> | jq -r .ImportTaskId)</pre>
</div>
</div>
</li>
<li>
<p>You can check the progress of the disk image to snapshot conversion job with the following command:</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# aws ec2 describe-import-snapshot-tasks --filters Name=task-state,Values=active</pre>
</div>
</div>
</li>
<li>
<p>Once the conversion job is complete, you can get the snapshot ID and store it in a variable called snapshot_id by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# snapshot_id=$(aws ec2 describe-snapshots | jq -r '.Snapshots[] | select(.Description | contains("'${task_id}'")) | .SnapshotId')</pre>
</div>
</div>
</li>
<li>
<p>Add a tag name to the snapshot, so it’s easier to identify, by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# aws ec2 create-tags --resources $snapshot_id --tags Key=Name,Value="$AMI_NAME"</pre>
</div>
</div>
</li>
<li>
<p>Register an AMI from the snapshot with the following command:</p>
<div class="listingblock">
<div class="content">
<pre>[root@ip-172-17-1-180 ~]# ami_id=$(aws ec2 register-image  \
    --name "$AMI_NAME" \
    --description "$AMI_NAME" \
    --architecture x86_64 \
    --root-device-name /dev/sda1 \
    --block-device-mappings "DeviceName=/dev/sda1,Ebs={VolumeSize=${DEFAULT_VOLUME_SIZE},SnapshotId=${snapshot_id}}" \
    --virtualization-type hvm \
    --ena-support \
    | jq -r .ImageId)</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ul>
</div>
<nav class="pagination">
  <span class="prev"><a href="section1.html">Lab: Launch RHEL 9 AWS Instance</a></span>
  <span class="next"><a href="section3.html">Lab: Deploying RHEL AI instance on AWS using the CLI</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
